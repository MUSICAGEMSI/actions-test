name: Coleta Musical - Supabase

on:
  # ğŸ• ExecuÃ§Ã£o automÃ¡tica todos os dias Ã s 00h43 (BrasÃ­lia)
  # BrasÃ­lia 00:43 = 03:43 UTC
  schedule:
    - cron: '43 3 * * *'

  # â–¶ï¸ ExecuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  coleta-supabase:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 HORAS

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt-dev

      - name: Instalar dependÃªncias Python
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install chromium --with-deps

      # ğŸ”¥ OtimizaÃ§Ã£o de kernel
      - name: Otimizar kernel Linux
        run: |
          echo "ğŸ”§ Otimizando kernel..."
          sudo sysctl -w net.ipv4.ip_local_port_range="1024 65535"
          sudo sysctl -w net.ipv4.tcp_tw_reuse=1
          sudo sysctl -w net.ipv4.tcp_fin_timeout=15
          sudo sysctl -w net.core.somaxconn=65535
          sudo sysctl -w net.core.netdev_max_backlog=65535
          sudo sysctl -w fs.file-max=2000000
          sudo sysctl -w net.ipv4.tcp_max_syn_backlog=8192
          sudo sysctl -w net.ipv4.tcp_keepalive_time=600
          sudo sysctl -w net.ipv4.tcp_keepalive_probes=3
          sudo sysctl -w net.ipv4.tcp_keepalive_intvl=15
          echo "âœ“ Kernel otimizado"
          sysctl net.ipv4.ip_local_port_range
          sysctl net.core.somaxconn
          echo "File descriptors: $(ulimit -n)"

      - name: Verificar instalaÃ§Ã£o
        run: |
          echo "ğŸ“¦ Verificando pacotes..."
          pip list | grep -E "httpx|h2|beautifulsoup4|playwright|supabase"
          python -c "import httpx; print(f'âœ“ httpx {httpx.__version__}')"
          python -c "import h2; print(f'âœ“ h2 {h2.__version__}')"

      # ğŸš€ EXECUÃ‡ÃƒO PRINCIPAL
      - name: ğŸµ Executar coleta Supabase
        env:
          LOGIN_MUSICAL: ${{ secrets.LOGIN_MUSICAL }}
          SENHA_MUSICAL: ${{ secrets.SENHA_MUSICAL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ EXECUTANDO script_supabase.py"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â±ï¸ Timeout: 6 horas"
          echo "ğŸ“œ Script: script_supabase.py"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          python script_supabase.py

      # ğŸ§¯ Upload em caso de erro
      - name: Upload artefatos (ERRO)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-supabase-${{ github.run_number }}
          path: |
            debug_*.png
            debug_*.html
            backup_*.json
            checkpoint_*.json
            *.log
          retention-days: 7
          if-no-files-found: ignore

      # ğŸ“¦ Upload em caso de sucesso
      - name: Upload backups e logs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coleta-supabase-${{ github.run_number }}
          path: |
            backup_*.json
            checkpoint_*.json
            *.log
          retention-days: 30
          if-no-files-found: ignore

      # ğŸ“Š RELATÃ“RIO FINAL
      - name: RelatÃ³rio final
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RELATÃ“RIO FINAL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Status: ${{ job.status }}"
          echo "Script: script_supabase.py"
          echo "Run: ${{ github.run_number }}"
          echo "UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "BRT: $(TZ=America/Sao_Paulo date '+%Y-%m-%d %H:%M:%S')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… COLETA SUPABASE FINALIZADA COM SUCESSO!"
          elif [ "${{ job.status }}" == "failure" ]; then
            echo "âŒ ERRO NA COLETA SUPABASE"
          else
            echo "âš ï¸ JOB CANCELADO OU TIMEOUT"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
