name: Executar Coleta HistÃ³rico Aulas
on:
  schedule:
    - cron: '0 12 12 * *'  # Todo dia 12 de cada mÃªs Ã s 12:00 UTC (09h BrasÃ­lia)
  workflow_dispatch:        # Permite disparo manual para testes
  
jobs:
  coleta-historico:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # Timeout de seguranÃ§a (1.5h)
    
    env:
      LOGIN_MUSICAL: ${{ secrets.LOGIN_MUSICAL }}
      SENHA_MUSICAL: ${{ secrets.SENHA_MUSICAL }}
      PYTHONUNBUFFERED: 1   # Para logs em tempo real
      
    steps:
      - name: ğŸ“‚ Clonar repositÃ³rio
        uses: actions/checkout@v4
        
      - name: ğŸ Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # Cache das dependÃªncias
          
      - name: ğŸ“¦ Instalar dependÃªncias Python
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests python-dotenv beautifulsoup4
          
      - name: ğŸŒ Instalar navegadores Playwright
        run: |
          python -m playwright install chromium
          python -m playwright install-deps chromium  # DependÃªncias do sistema
          
      - name: ğŸ” Verificar arquivos necessÃ¡rios
        run: |
          echo "ğŸ“ Arquivos no diretÃ³rio:"
          ls -la
          echo ""
          echo "ğŸ”‘ Verificando variÃ¡veis de ambiente:"
          echo "LOGIN_MUSICAL definido: ${{ env.LOGIN_MUSICAL != '' }}"
          echo "SENHA_MUSICAL definido: ${{ env.SENHA_MUSICAL != '' }}"
          
      - name: ğŸš€ Executar script_historicoaulas.py
        run: |
          echo "ğŸ¯ Iniciando coleta do histÃ³rico de aulas..."
          echo "â° HorÃ¡rio de inÃ­cio: $(date)"
          python script_historicoaulas.py
        timeout-minutes: 80  # Timeout especÃ­fico do script
        
      - name: ğŸ“Š Upload de logs em caso de erro
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-erro-coleta
          path: |
            backup_dados.json
            *.log
          retention-days: 7
          
      - name: ğŸ“ˆ RelatÃ³rio de conclusÃ£o
        if: always()
        run: |
          echo "â° HorÃ¡rio de tÃ©rmino: $(date)"
          echo "ğŸ“Š Status do job: ${{ job.status }}"
          if [ -f "backup_dados.json" ]; then
            echo "ğŸ’¾ Backup encontrado - dados foram salvos localmente"
            echo "ğŸ“ Tamanho do backup: $(du -h backup_dados.json)"
          fi
