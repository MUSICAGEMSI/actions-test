name: Musical Analytics - ExecuÃ§Ã£o DiÃ¡ria

on:
  schedule:
    - cron: '0 12 12 * *'  # Todo dia 12 de cada mÃªs Ã s 12:00 UTC (09h BrasÃ­lia)
  workflow_dispatch:        # Permite disparo manual
  
jobs:
  run-scripts:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Clonar o repositÃ³rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
          
      - name: Verificar arquivos do projeto
        run: |
          echo "ğŸ“ Arquivos encontrados no repositÃ³rio:"
          ls -la
          echo ""
          echo "ğŸ” Procurando por arquivos Python:"
          find . -name "*.py" -type f
          echo ""
          if [ -f requirements.txt ]; then
            echo "ğŸ“‹ ConteÃºdo do requirements.txt:"
            cat requirements.txt
          else
            echo "âš ï¸ Arquivo requirements.txt nÃ£o encontrado"
          fi
          
      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # Verificar se requirements.txt existe
          if [ -f requirements.txt ]; then
            echo "ğŸ“¦ Instalando dependÃªncias do requirements.txt..."
            pip install -r requirements.txt
          else
            echo "ğŸ“¦ Instalando dependÃªncias manualmente..."
            pip install supabase==2.9.1 pandas==2.2.3 python-dotenv==1.0.1
            pip install matplotlib==3.9.2 seaborn==0.13.2 openpyxl==3.1.5
            pip install playwright==1.48.0 beautifulsoup4==4.12.3 requests==2.32.3
          fi
          
          # Instalar playwright browsers
          python -m playwright install chromium --with-deps
          
      - name: Verificar instalaÃ§Ã£o das dependÃªncias
        run: |
          echo "ğŸ” Verificando dependÃªncias instaladas..."
          python -c "
          import sys
          
          # Lista de dependÃªncias para verificar
          deps = [
              ('pandas', 'pandas'),
              ('supabase', 'supabase'),  
              ('dotenv', 'python-dotenv'),
              ('matplotlib.pyplot', 'matplotlib'),
              ('seaborn', 'seaborn'),
              ('openpyxl', 'openpyxl'),
              ('requests', 'requests'),
              ('playwright', 'playwright')
          ]
          
          print('ğŸ“¦ Status das dependÃªncias:')
          all_ok = True
          
          for module, package in deps:
              try:
                  mod = __import__(module)
                  version = getattr(mod, '__version__', 'N/A')
                  print(f'âœ… {package}: {version}')
              except ImportError as e:
                  print(f'âŒ {package}: NÃƒO INSTALADO ({e})')
                  all_ok = False
          
          if not all_ok:
              print('âŒ Algumas dependÃªncias faltam!')
              sys.exit(1)
          else:
              print('âœ… Todas as dependÃªncias estÃ£o OK!')
          "
          
      - name: Criar arquivo de credenciais
        run: |
          echo "ğŸ” Criando arquivo de credenciais..."
          cat > credencial.env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
          LOGIN_MUSICAL=${{ secrets.LOGIN_MUSICAL }}
          SENHA_MUSICAL=${{ secrets.SENHA_MUSICAL }}
          EOF
          
          # Verificar se as variÃ¡veis foram definidas (sem mostrar valores)
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âš ï¸ SUPABASE_URL nÃ£o definida"
          else
            echo "âœ… SUPABASE_URL definida"
          fi
          
          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
            echo "âš ï¸ SUPABASE_KEY nÃ£o definida"  
          else
            echo "âœ… SUPABASE_KEY definida"
          fi
          
      - name: Testar conexÃ£o Supabase
        run: |
          echo "ğŸ”— Testando conexÃ£o com Supabase..."
          python -c "
          import os
          from dotenv import load_dotenv
          from supabase import create_client
          
          # Carregar variÃ¡veis do arquivo
          load_dotenv('credencial.env')
          
          try:
              url = os.environ.get('SUPABASE_URL')
              key = os.environ.get('SUPABASE_ANON_KEY')
              
              if not url:
                  raise Exception('SUPABASE_URL nÃ£o encontrada')
              if not key:
                  raise Exception('SUPABASE_ANON_KEY nÃ£o encontrada')
              
              # Testar conexÃ£o
              supabase = create_client(url, key)
              
              # Fazer uma consulta simples para testar
              result = supabase.table('aulas').select('count').limit(1).execute()
              
              print('âœ… ConexÃ£o Supabase estabelecida com sucesso!')
              print(f'ğŸ“Š Banco de dados acessÃ­vel')
              
          except Exception as e:
              print(f'âŒ Erro na conexÃ£o Supabase: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          "
          
      - name: Executar script principal
        id: main-script
        run: |
          echo "ğŸš€ Iniciando execuÃ§Ã£o do script principal..."
          echo "ğŸ“… Data/Hora: $(date)"
          
          if [ -f script_historicoaulas.py ]; then
            echo "ğŸ“ Executando script_historicoaulas.py..."
            timeout 20m python script_historicoaulas.py
          else
            echo "âŒ Arquivo script_historicoaulas.py nÃ£o encontrado!"
            ls -la *.py 2>/dev/null || echo "Nenhum arquivo .py encontrado"
            exit 1
          fi
          
      - name: Executar anÃ¡lise adicional (opcional)
        if: success()
        continue-on-error: true
        run: |
          if [ -f musical_analytics.py ]; then
            echo "ğŸ“Š Executando anÃ¡lise musical adicional..."
            timeout 10m python musical_analytics.py
          else
            echo "â„¹ï¸ Arquivo musical_analytics.py nÃ£o encontrado (opcional)"
          fi
          
      - name: Listar arquivos gerados
        if: always()
        run: |
          echo "ğŸ“ Arquivos gerados na execuÃ§Ã£o:"
          ls -la *.xlsx *.png *.log *.csv 2>/dev/null || echo "Nenhum arquivo de saÃ­da encontrado"
          
      - name: Upload de relatÃ³rios e logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-musical-${{ github.run_number }}
          path: |
            *.xlsx
            *.png  
            *.log
            *.csv
            *.json
          retention-days: 30
          if-no-files-found: warn
          compression-level: 9
          
      - name: Cleanup - Remover arquivos sensÃ­veis
        if: always()
        run: |
          echo "ğŸ§¹ Removendo arquivos sensÃ­veis..."
          rm -f credencial.env
          rm -f .env
          
      - name: Resultado da execuÃ§Ã£o
        if: always()
        run: |
          if [ "${{ steps.main-script.outcome }}" = "success" ]; then
            echo "âœ… Script executado com SUCESSO!"
            echo "ğŸ“… ConcluÃ­do em: $(date)"
            echo "ğŸ¯ PrÃ³xima execuÃ§Ã£o: dia 12 do prÃ³ximo mÃªs Ã s 12:00 UTC"
          else
            echo "âŒ Script falhou durante a execuÃ§Ã£o"
            echo "ğŸ“… Falha em: $(date)"
            echo "ğŸ” Verifique os logs acima para mais detalhes"
            exit 1
          fi
